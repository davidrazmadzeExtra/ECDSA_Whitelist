<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script
      src="https://cdn.ethers.io/lib/ethers-5.1.umd.min.js"
      type="application/javascript"
    ></script>
  </head>
  <body>
    <script type="text/javascript">
      //See: https://github.com/ethers-io/ethers.js/
      //These contents must match the ones used in contract
      //Do not discose the below values.
      const SIGNING_DOMAIN_NAME = "anyname";
      const SIGNING_DOMAIN_VERSION = "1";

      class SignHelper {
        constructor(contractAddress, chainId, signer) {
          this.contractAddress = contractAddress;
          this.chainId = chainId;
          this.signer = signer;
        }

        //you can add any number of uint256 or string but this should also match with the contract
        async createSignature(id, name) {
          const obj = { id, name };
          const domain = await this._signingDomain();
          const types = {
            Web3Struct: [
              { name: "id", type: "uint256" },
              { name: "name", type: "string" },
            ],
            //the entered values will be hashed with user address and private key,
            //which will generate a signature.
          };
          const signature = await this.signer._signTypedData(
            domain,
            types,
            obj
          );
          return { ...obj, signature };
        }

        async _signingDomain() {
          if (this.domain != null) {
            return this._domain;
          }
          const chainId = await this.chainId;
          this._domain = {
            name: SIGNING_DOMAIN_NAME,
            version: SIGNING_DOMAIN_VERSION,
            verifyingContract: this.contractAddress,
            chainId,
          };
          return this._domain;
        }

        static async getSign(contractAddress, chainId, id, name) {
          var provider = new ethers.providers.Web3Provider(window.ethereum);

          await provider.send("eth_requestAccounts", []);
          var signer = provider.getSigner();
          await signer.getAddress();

          var lm = new SignHelper(contractAddress, chainId, signer);
          var voucher = await lm.createSignature(id, name);

          return voucher;
        }
      }
    </script>
  </body>
</html>
